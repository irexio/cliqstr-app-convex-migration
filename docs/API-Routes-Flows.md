# Cliqstr API Routes and Flow Documentation

*This file is automatically generated. Last updated: 2025-08-08T15:50:34.894Z*

## API Routes

| Route | Methods | Description |
| ----- | ------- | ----------- |
| `/accept-invite` | POST | üîê APA-HARDENED ROUTE: POST /api/accept-invite Purpose: - Accepts an invite using the provided invite code - Adds the current user to the cliq - Marks the invite as used - Handles different invite types (adult vs child) Body Params: - inviteCode: string (required) Returns: - 200 OK with cliqId if successful - 400 if no code is provided - 401 if user is not authenticated - 404 if invite is not found - 410 if invite is already used or expired Security: - Requires user authentication - For child invites, requires adult verification - Enforces APA-compliant access control |
| `/admin/force-password-reset` | POST | Admin API to force password reset for a user POST /api/admin/force-password-reset |
| `/auth/refresh-session` | GET | üîÑ APA-COMPLIANT SESSION REFRESH ENDPOINT |
| `/auth/request-reset` | POST | Allow 1 reset request per 10 minutes per email |
| `/auth/status` | GET | üîê APA-HARDENED FALLBACK ROUTE: GET /api/auth/status |
| `/auth/submit-reset` | POST | Audit log |
| `/auth/upgrade-to-parent` | POST | üîÑ Upgrade Adult to Parent API Silently upgrades an Adult user with a paid plan to Parent role when they're approving a child invite. This is Sol's optimized flow for users who have already verified their identity with payment. |
| `/auth/verify-parent` | POST | üîí Verify Parent API (Testing Version) For free adults approving child invites - simulates identity verification without actual Stripe integration. In production, this would use Stripe SetupIntent for $0 card verification. |
| `/cliqs/create` | POST | üîê APA-HARDENED ROUTE: POST /api/cliqs/create Purpose: - Creates a new cliq for the authenticated user - Adds the creator to the cliq's membership Auth: - Requires valid session (user.id) Body: - name: string - description?: string - privacy: 'private' | 'semi' | 'public' - coverImage?: string (optional; uses default if blank) Returns: - 200 OK + new cliq - 401 if unauthorized - 400 if invalid input - 500 on error |
| `/cliqs/feed` | GET | üîê APA-HARDENED ROUTE: GET /api/cliqs/feed?id={cliqId} Purpose: - Returns all active (non-expired) posts and their replies for a specific cliq - Requires that the requester is a member of the cliq Auth: - Validates session with getCurrentUser - Confirms user is a member of the cliq via the membership table Query Params: - id: string (cliqId) ‚Äî required Output: - Array of posts ordered by `createdAt DESC` - Each post includes: - Author username - Replies ordered ASC - Reply author usernames Notes: - Posts are filtered to only include those with future `expiresAt` - This route intentionally uses query params instead of file-based [id] to avoid Next.js type shadowing bugs Completion: ‚úÖ APA-safe and production-ready as of June 30, 2025 |
| `/cliqs` | GET | üîê APA-HARDENED ROUTE: GET /api/cliqs?id={cliqId} Purpose: - Returns public info about a cliq based on the query parameter - Used when viewing cliq details safely without revealing private data Auth: - Requires user to be logged in - Requires user to be a member of the cliq Query Param: - id: string (cliq ID) Returns: - 200 OK with cliq summary info - 401 if unauthenticated or missing cliq ID - 403 if user is not a member of the cliq - 404 if cliq does not exist - 500 on server error |
| `/cliqs/[id]/join` | POST | üîê APA-HARDENED ROUTE: POST /api/cliqs/[id]/join Purpose: - Allows users to join a cliq with age gating validation - Enforces APA-safe age restrictions using Account.birthdate - Validates parental controls for children Auth: - Requires valid session (user.id) - Uses Account.birthdate for age verification (immutable) Age Gating Logic: - Check cliq.minAge and cliq.maxAge against user's Account.birthdate - For children: validate canJoinPublicCliqs permission - Reject if age requirements not met Returns: - 200 OK + membership created - 401 if unauthorized - 403 if age restriction not met or parent permission denied - 409 if already a member - 500 on error |
| `/cliqs/[id]/member-actions` | Unknown | üîê APA-HARDENED ROUTE: POST /api/cliqs/[id]/member-actions Purpose: - Allows a user (with proper permissions) to remove, promote, or demote a member. Auth: - Uses getCurrentUser() for session validation - Requires user to be a member of the cliq Body Input: { targetUserId: string, action: 'remove' | 'promote' | 'demote' } Returns: - 200 OK on success - 401 if unauthenticated - 403 if not a member - 400 if invalid input - 500 on DB/server error |
| `/cliqs/[id]/members` | GET | üîê APA-HARDENED ROUTE: GET /api/cliqs/[id]/members Purpose: - Returns all members of a cliq (with email + profile) Auth: - Requires user to be a member of the cliq |
| `/cliqs/[id]/notices/admin` | POST, DELETE | üõ†Ô∏è APA-HARDENED ROUTE: POST /api/cliqs/[id]/notices/admin Purpose: - Allows cliq owners to create admin notices - Used for announcements, reminders, schedule changes - Only accessible to cliq owners/moderators Auth: - Requires valid session (user.id) - User must be the owner of the cliq Body: - content: string (notice message) - expiresAt?: string (optional expiration date) Returns: - 200 OK + created notice - 401 if unauthorized - 403 if not cliq owner - 400 if invalid input - 500 on error |
| `/cliqs/[id]/notices/red-alert` | GET, POST | üö® APA-HARDENED ROUTE: POST /api/cliqs/[id]/notices/red-alert Purpose: - Creates red alert notices when safety concerns are reported - Automatically triggered by Red Alert button - Creates both "open" and "resolved" notices as needed Auth: - Requires valid session (user.id) - User must be a member of the cliq Body: - action: 'open' | 'resolve' - redAlertId?: string (for resolve action) Returns: - 200 OK + created notice - 401 if unauthorized - 403 if not cliq member - 400 if invalid input - 500 on error |
| `/cliqs/[id]/notices` | GET | üîî APA-HARDENED ROUTE: GET /api/cliqs/[id]/notices Purpose: - Fetches active notices for a specific cliq - Auto-generates birthday notices based on MyProfile.birthdate - Filters expired notices automatically - Only accessible to cliq members (APA-safe) Auth: - Requires valid session (user.id) - User must be a member of the cliq Returns: - 200 OK + array of active notices - 401 if unauthorized - 403 if not a cliq member - 404 if cliq not found - 500 on error |
| `/cliqs/[id]` | GET, DELETE, PATCH | üîê APA-HARDENED ROUTE: GET, PATCH, DELETE /api/cliqs/[id] Purpose: - GET: Fetch cliq metadata (requires membership) - PATCH: Update cliq info (owner only) - DELETE: Soft-delete cliq (owner only) Auth: - All methods use getCurrentUser() - PATCH/DELETE restricted to cliq owner |
| `/complete-approval` | POST | now supports: 'free', 'paid', 'ebt' |
| `/create-checkout-session` | POST | Check if Stripe secret key is available |
| `/create-setup-intent` | POST | üì¶ Stripe SetupIntent API ‚Äî used for adding payment methods |
| `/debug-uploadthing` | GET | No description available |
| `/dev-reset` | GET | No description available |
| `/get-child-info` | POST | Check if Stripe secret key is available |
| `/invite/create` | POST | üîê APA-HARDENED ‚Äî Invite Email Sender & Creator |
| `/invite/decline` | GET | üîê APA-HARDENED ‚Äî Invite Decline Handler Purpose: Allows parents to decline child invites to cliqs Method: GET (simple link from email) Flow: 1. Validate invite code 2. Mark invite as declined 3. Log decline timestamp 4. Redirect to confirmation page |
| `/invite-request/approve` | POST | üîê APA-HARDENED ROUTE: POST /api/invite-request/approve Purpose: - Allows a verified parent or adult to approve a pending invite request (usually submitted by a child user or system-initiated invite) Features: - Authenticates the current user - Ensures only adults (non-child profiles) can approve - Fetches the original inviteRequest by ID - Creates a new invite with `isApproved: true` - Deletes the original pending request Used In: - Parent HQ or email approval flow for child invites - Admin dashboard (future: moderation review tools) Related Routes: - /api/invite/create ‚Üí creates invite or inviteRequest depending on role - /api/validate-invite ‚Üí used during sign-up Completion: ‚úÖ Fully live and APA-compliant as of June 30, 2025 |
| `/invites/validate` | GET | No description available |
| `/parent/approval-complete` | POST | üîê APA-HARDENED ROUTE: POST /api/parent/approval-complete |
| `/parent/child/reset-credentials` | POST | POST /api/parent/child/reset-credentials |
| `/parent/child/suspend` | POST | POST /api/parent/child/suspend |
| `/parent/child-credentials/update` | POST | üîê APA-HARDENED ROUTE: POST /api/parent/child-credentials/update Purpose: - Allows a parent to set up or update their child's username and password - Part of the APA-compliant flow where parents must create credentials for children - Updates both the user profile (username) and user auth (password) Body Params: - childId: string (required) - The ID of the child user - username: string (required) - The new username for the child - password: string (required) - The new password for the child Returns: - 200 OK if credentials updated successfully - 400 if missing required params - 403 if not authorized (not parent of this child) - 404 if child not found - 500 if server error |
| `/parent/child-profile` | GET | üîê APA-HARDENED ROUTE: GET /api/parent/child-profile Purpose: - Returns detailed child profile and settings for parent dashboard - Includes MyProfile data (name, birthdate) and ChildSettings Auth: - Requires a logged-in parent user - Validates parent is linked to the requested child Query Parameters: - childId: string (required) - ID of the child to fetch Returns: - 200 OK with { myProfile, childSettings } - 401 if not authenticated - 403 if not linked to child - 404 if child not found - 500 on server error Used In: - ParentDashboard.tsx (fetching detailed child data) |
| `/parent/children` | GET | üîê APA-HARDENED ROUTE: GET /api/parent/children Purpose: - Returns all child profiles linked to the currently authenticated parent - Used to populate the dropdown in ParentDashboard Auth: - Requires a logged-in parent user (validated via email) - Matches children via ParentLink table (email ‚Üî childId) Returns: - 200 OK with array of child profiles: [{ id, name?, email? }] - 401 if not authenticated - 500 on server error Used In: - ParentDashboard.tsx (child selector for ParentsHQPage) |
| `/parent/invite-request` | GET | src/app/api/parent/invite-request/route.ts |
| `/parent/pending-children` | GET | GET /api/parent/pending-children |
| `/parent/settings/update` | POST | üîê APA-HARDENED ROUTE: POST /api/parent/settings/update Purpose: - Allows verified parents to update permissions and visibility settings for a specific child account they are linked to. Features: - Validates input using Zod - Ensures the parent is authenticated and linked to the child via ParentLink - Updates child settings in the profile table (e.g., invite ability, public cliqs, media access) Used In: - ParentsHQPage (toggle controls and visibility settings) - ParentDashboard wrapper (per-child management UI) Completion: ‚úÖ Fully implemented and APA-compliant as of June 30, 2025 |
| `/parent-approval/complete` | POST | Create child account from invite note |
| `/parent-approval/request` | GET, POST | üîê APA-HARDENED ROUTE: POST /api/parent-approval/request Purpose: - Handles child sign-up requests that require parent approval - Sends approval email to parent/guardian - Stores pending approval in database Body Params: - childFirstName: string (required) - childBirthdate: string (required) - parentEmail: string (required) Returns: - 200 OK if approval request sent successfully - 400 if missing required fields - 500 if server error Security: - No account created until parent approves - APA-compliant child protection flow |
| `/parent-approval/start` | GET | üîê APA-HARDENED ROUTE: GET /api/parent-approval/start Purpose: - Initiates the parent approval flow for child invites - Validates the invite and redirects to appropriate approval page - Ensures proper APA compliance for child account creation Query Params: - code: string (required) - The invite code Returns: - Redirects to appropriate approval flow based on user status Security: - Requires user authentication - Validates invite is for child type - Enforces parent/guardian role requirements |
| `/parent-approval/validate` | GET | üîê APA-HARDENED ROUTE: GET /api/parent-approval/validate Purpose: - Validates parent approval request - Returns child information for preview Query Params: - inviteCode: string (required) - childId: string (required) Returns: - 200 OK with child info if valid - 400 if missing required params - 404 if invite not found - 500 if server error |
| `/posts/create` | POST | üîê APA-HARDENED ROUTE: POST /api/posts/create Purpose: - Creates a new post inside a specific cliq - Supports optional image and text content - Sets default expiration at 90 days Auth: - Uses getCurrentUser() for session validation Input Body: { content?: string, image?: string (URL), cliqId: string } Returns: - 200 OK + new post - 401 if unauthenticated - 400 if invalid input or missing content - 500 on DB/server error |
| `/posts/[id]/replies` | GET, POST | üîê APA-HARDENED ROUTE: /api/posts/[id]/replies Purpose: - GET: Fetch all replies for a post - POST: Create a new reply to a post Auth: - Requires user to be a member of the cliq that contains the post |
| `/profile/create` | POST | üîê APA-HARDENED ROUTE: POST /api/profile/create Purpose: - Creates a social media profile for authenticated user - Uses firstName, lastName, birthdate from sign-up data - Sets username, bio, avatar, banner for social features Auth: - Requires valid session (user.id) - User must not already have a profile Body: - username: string (3-15 chars, alphanumeric + underscore) - firstName: string - lastName: string - birthdate: string (ISO date) - about?: string (bio/description) - image?: string (avatar URL) - bannerImage?: string (banner URL) Returns: - 200 OK + profile data - 401 if unauthorized - 400 if invalid input or profile exists - 500 on error |
| `/profile/me` | GET | Get full profile data |
| `/profile/update` | POST | Check if username is already taken (excluding current user) - only if username is provided |
| `/red-alert` | POST | POST /api/red-alert |
| `/replies` | POST | üîê APA-HARDENED ‚Äî Create a reply to a post |
| `/resend-verification` | POST | Define validation schema |
| `/reset-password` | POST | üîê APA-HARDENED RESET PASSWORD ENDPOINT |
| `/scrapbook/add` | POST | üîê APA-HARDENED ROUTE: POST /api/scrapbook/add Purpose: - Adds a new item to user's scrapbook/gallery - Stores uploaded image URL with caption Auth: - Requires valid session (user.id) - User must have a profile Body: - imageUrl: string (from UploadThing) - caption: string (optional) - profileId: string Returns: - 200 OK + scrapbook item - 401 if unauthorized - 400 if invalid input - 500 on error |
| `/scrapbook/[profileId]` | GET | üîê APA-HARDENED ROUTE: GET /api/scrapbook/[profileId] Purpose: - Fetches scrapbook items for a profile - Only returns items if users share a cliq Auth: - Requires valid session (user.id) - Enforces cliq membership check Returns: - 200 OK + scrapbook items array - 401 if unauthorized - 403 if no shared cliq - 500 on error |
| `/send-parent-email` | POST | üîê APA-HARDENED ROUTE: POST /api/send-parent-email üõ†Ô∏è INTERNAL USE ONLY Purpose: - Sends parent approval emails for child account creation - Internal helper route for invite flow - Not intended for direct external API calls Tags: Internal, Helper, Email ‚ö†Ô∏è This is an internal helper route - use invite/create instead |
| `/send-reset-email` | POST | API route handler for sending password reset emails Uses the consolidated sendResetEmail helper from lib/auth |
| `/sign-in` | POST | üîê APA-SAFE LOGIN ROUTE ‚Äî FINAL VERSION Authenticates user with email/password, verifies child approval, issues secure session cookie via NextResponse headers. ‚úÖ No persistent tokens used ‚úÖ Role and approval validation ‚úÖ Secure session-based auth only ‚úÖ Legacy tokens cleared |
| `/sign-out` | POST | API Route for signing out users Clears auth_token cookie and any other session data |
| `/sign-up` | POST | üîê APA-HARDENED ‚Äî Sign-Up API Route |
| `/test-email` | GET | Simple test endpoint to verify Resend API is working Access via: /api/test-email?email=your@email.com |
| `/test-email-debug` | GET | Check environment variables |
| `/test-uploadthing` | GET | Test UploadThing environment variables |
| `/uploadthing` | Unknown | Create and export the route handlers with debug logging |
| `/user/plan` | POST | API endpoint to save user's plan selection This is called from the choose-plan page For free/test plans, this directly updates the Account record For paid plans, this would normally redirect to Stripe |
| `/verify-email` | GET | Email Verification API Endpoint Purpose: - Processes email verification tokens - Marks accounts as verified when users click verification links - Required verification (users must verify before accessing the app) |
| `/webhooks/stripe` | POST | Stripe Webhook API Route This webhook handler processes Stripe events, particularly focusing on payment success to automatically verify user accounts when they make a successful payment. |

## Page Flows

| Page | Redirects To | Description |
| ---- | ------------ | ----------- |
| `/about` | None | No description available |
| `/account` | `/` | üîê APA-SAFE ‚Äî Account settings page (private to the logged-in user) |
| `/admin` | None | Check if user is authenticated and has admin role |
| `/awaiting-approval` | None | No description available |
| `/child/onboarding` | None | Purpose: - Child's first login experience after parent approval - Allows child to set their own nickname (3-20 chars, no profanity) - Parents can view but not control the nickname (APA compliance) - Nickname used in comments, posts, member lists, dashboards Flow: 1. Parent approves child account ‚Üí child gets login credentials 2. Child logs in for first time ‚Üí redirected here 3. Child chooses nickname ‚Üí saved to User.nickname field 4. Child redirected to /my-cliqs-dashboard Database: - Requires User.nickname field (not yet implemented) - Validation: 3-20 chars, letters/numbers/basic symbols, no profanity |
| `/child-account-created` | None | No description available |
| `/choose-plan` | `/sign-in`, `/sign-in`, `/my-cliqs-dashboard` | User verification is handled during sign-up flow |
| `/cliqs/build` | None | No description available |
| `/cliqs/create` | None | üîê APA-HARDENED ‚Äî Create New Cliq Page |
| `/cliqs/feed` | None | üîê APA-HARDENED PAGE: /cliqs/feed Purpose: - Renders the logged-in user‚Äôs cliq feed - Displays posts that already include author information Auth: - Requires a valid user session - Redirects to 404 if unauthenticated Notes: - Does NOT pass userId to CliqFeed (posts contain their own author info) - Dynamic rendering prevents static caching |
| `/cliqs/[id]/edit` | `/sign-in` | üîê APA-HARDENED ‚Äî Edit Cliq Page |
| `/cliqs/[id]/invite` | None | üîê APA-HARDENED ‚Äî Cliq Invite Page - 070325 |
| `/cliqs/[id]/member-actions` | None | üîê APA-HARDENED PAGE: /cliqs/[id]/member-actions |
| `/cliqs/[id]/members` | None | üîê APA-HARDENED PAGE: /cliqs/[id]/members |
| `/cliqs/[id]` | None | üîê APA-Hardened: View Cliq Feed ‚Äî /cliqs/[id]/page.tsx |
| `/debug/invite-flow` | None | üîç DEBUG TOOL: Invite Flow Tracer This tool helps debug invite flow issues by: 1. Testing invite code validation 2. Checking user auth status 3. Simulating the invite flow |
| `/debug/session-check` | None | No description available |
| `/email-confirmation` | None | üîê APA-HARDENED ‚Äî Email Confirmation Page Displayed after adult sign-up to inform users to check their email Part of the APA-compliant adult sign-up flow |
| `/explore` | None | No description available |
| `/faqs` | None | No description available |
| `/features` | None | No description available |
| `/for-parents` | None | No description available |
| `/forgot-password` | None | No description available |
| `/how-it-works` | None | No description available |
| `/invite/accept` | None | üîê APA-HARDENED ‚Äî Invite Acceptance Page üîÑ REDIRECT HELPER |
| `/invite/adult` | None | Using iron-session, NOT next-auth |
| `/invite/declined` | None | üîê APA-HARDENED ‚Äî Invite Declined Confirmation Page Shows confirmation when a parent declines a child's cliq invite Handles different states: success, already declined, errors |
| `/invite/invalid` | None | No description available |
| `/invite/manual` | None | Pre-fill code from URL if provided |
| `/invite/parent` | None | üîí Validate invite on mount |
| `/invite/parent/signup` | None | üõ°Ô∏è DEDICATED Parent Invite Sign-Up Page This is a separate sign-up flow specifically for new parents who receive child invites. It doesn't interfere with the main sign-up flow and ensures proper redirect to Parent HQ. |
| `/invite/sent` | None | Clear any stored invite data |
| `/join` | None | Join Page Purpose: - Landing page when users enter an invite code - Allows existing users to sign in and new users to sign up with pre-filled invite code - Automatically used for "Join a Cliq" flow - Server component that gets invite code from params and passes to client component |
| `/my-cliqs-dashboard` | None | üìÇ MyCliqs Dashboard ‚Äî /my-cliqs-dashboard üîê APA-Hardened: Accessible only to logged-in users (child or adult) What this page does: - Displays all cliqs the current user owns or is a member of - Queries both `cliqs` (ownerId) and `memberships` (joined) - Renders a responsive grid of cards (1 mobile ‚Ä¢ 2 tablet ‚Ä¢ 3 desktop) - Each card includes: - Banner image (if uploaded) or fallback gradient - Cliq name, privacy level, description - Action buttons: View Cliq ‚Ä¢ View Members ‚Ä¢ Invite Someone This page serves as the user's central dashboard and launchpad. It is the starting point for nearly all major actions after login. Used in flows: - Direct sign-up (adult or child) - Post-import |
| `/not-authorized` | None | No description available |
| `/` | None | üîê APA-HARDENED by Aiden ‚Äî public homepage entrypoint |
| `/parent-approval` | None | üîê APA-HARDENED ‚Äî Parent Approval Landing Page |
| `/parents/approval` | None | üîê APA-HARDENED ‚Äî Parent Approval Landing Page |
| `/parents/hq` | None | No description available |
| `/pricing` | None | No description available |
| `/privacy` | None | No description available |
| `/profile/create` | `/sign-in`, `/my-cliqs-dashboard` | üîê APA-HARDENED ‚Äî Secure Create Profile Page |
| `/profile/edit` | `/login`, `/profile/create` | No description available |
| `/profile` | `/sign-in`, `/profile/create` | üîê APA-HARDENED ‚Äî Profile Redirect Page |
| `/profile/[username]` | None | üîê APA-HARDENED PAGE: /profile/[username] |
| `/reset-password` | None | üîê APA-HARDENED by Aiden ‚Äî Password Reset Page |
| `/safety` | None | No description available |
| `/session-ping` | `/sign-in`, `/my-cliqs-dashboard`, `/email-confirmation`, `/choose-plan`, `/choose-plan`, `/my-cliqs-dashboard` | üîê APA-HARDENED SESSION PING PAGE |
| `/sign-in` | None | üîê APA-HARDENED SIGN-IN PAGE |
| `/sign-up` | None | üîê APA-HARDENED SIGN-UP PAGE |
| `/suspended` | None | üîê APA SUSPENDED PAGE ‚Äî shown to users whose accounts are suspended |
| `/terms` | None | No description available |
| `/test-avatar` | None | No description available |
| `/test-simple` | None | No description available |
| `/test-upload` | None | No description available |
| `/verification-error` | None | Email Verification Error Page Displayed when there's an issue with email verification |
| `/verification-pending` | None | Retrieve email from localStorage on component mount |
| `/verification-success` | None | Email Verification Success Page Displayed when a user successfully verifies their email address |
| `/verify-card` | `/sign-in` | No description available |
| `/verify-email` | None | Email Verification Page This page handles the verification link from emails It extracts the code from the URL and forwards it to the API |
| `/verify-parent` | None | Check authentication and validate user can access this page |

## Recent Changes

```
11110a8 - Merge branch 'main' into codex/render-invite-button-conditionally (2 hours ago)
726e694 - Restrict invite UI to owners or public cliqs (3 hours ago)
53ce3fd - Merge pull request #2 from irexio/codex/update-cliq-lookup-and-privacy-check (3 hours ago)
174723d - feat: protect cliq invite page (3 hours ago)
f79f028 - Restrict invite creation in private cliqs (3 hours ago)
e33f896 - Fix: invite accept page now supports both invitedRole and inviteRole (3 days ago)
8431616 - Fix: properly route child and adult invites with APA-safe fallback (3 days ago)
763ec45 - Add friendly fallback for expired or invalid invite codes (3 days ago)
9dd1741 - Fix: Harden parent invite routing and session logic (APA-safe) (3 days ago)
64cedac - CRITICAL FIX: Parent Invite Flow - Session-Ping Bypass Issue (3 days ago)
```
