generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String            @id @default(cuid())
  email               String            @unique
  password            String
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  deletedAt           DateTime?
  resetToken          String?
  resetTokenExpires   DateTime?
  verificationExpires DateTime?
  verificationToken   String?
  isVerified          Boolean           @default(false)
  isParent            Boolean           @default(false)
  account             Account?
  ownedCliqs          Cliq[]            @relation("CliqOwner")
  invitesSent         Invite[]          @relation("SentInvites")
  inviteRequestsSent  InviteRequest[]   @relation("InviteRequestsSent")
  memberships         Membership[]
  myProfile           MyProfile?
  parentAuditLogs     ParentAuditLog[]  @relation("ParentAuditLogs")
  parentChildLinks    ParentLink[]      @relation("ParentChildLinks")
  parentLinks         ParentLink[]      @relation("ParentLinks")
  Post                Post[]
  redAlertsTriggered  RedAlert[]
  Reply               Reply[]
  activityLogs        UserActivityLog[]
}

model MyProfile {
  id                String            @id @default(cuid())
  username          String            @unique
  birthdate         DateTime
  createdAt         DateTime          @default(now())
  userId            String            @unique
  ageGroup          String?
  about             String?
  bannerImage       String?
  image             String?
  updatedAt         DateTime          @updatedAt
  aiModerationLevel AIModerationLevel @default(strict)
  firstName         String?
  lastName          String?
  showYear          Boolean           @default(false)
  childSettings     ChildSettings?
  user              User              @relation(fields: [userId], references: [id], map: "Profile_userId_fkey")
  scrapbookItems    ScrapbookItem[]
}

model ChildSettings {
  id                     String    @id @default(cuid())
  profileId              String    @unique
  canCreatePublicCliqs   Boolean   @default(false)
  canJoinPublicCliqs     Boolean   @default(false)
  canCreateCliqs         Boolean   @default(false)
  canSendInvites         Boolean   @default(false)
  canInviteChildren      Boolean   @default(false)
  canInviteAdults        Boolean   @default(false)
  isSilentlyMonitored    Boolean   @default(true)
  aiModerationLevel      String?
  canAccessGames         Boolean   @default(false)
  canPostImages          Boolean   @default(false)
  canShareYouTube        Boolean   @default(false)
  visibilityLevel        String?
  inviteRequiresApproval Boolean   @default(true)
  myProfile              MyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

/// üîê APA ‚Äî System-level metadata for each user
model Account {
  id               String   @id @default(cuid())
  userId           String   @unique
  birthdate        DateTime
  role             String
  isApproved       Boolean  @default(false)
  stripeStatus     String?
  plan             String?
  stripeCustomerId String?
  createdAt        DateTime @default(now())
  suspended        Boolean  @default(false)
  user             User     @relation(fields: [userId], references: [id])
}

model Cliq {
  id             String          @id @default(cuid())
  name           String
  description    String?
  ownerId        String
  createdAt      DateTime        @default(now())
  deleted        Boolean         @default(false)
  deletedAt      DateTime?
  coverImage     String?
  privacy        String          @default("private")
  minAge         Int?
  maxAge         Int?
  owner          User            @relation("CliqOwner", fields: [ownerId], references: [id])
  notices        CliqNotice[]
  invites        Invite[]        @relation("CliqInvites")
  inviteRequests InviteRequest[] @relation("CliqInviteRequests")
  memberships    Membership[]
  posts          Post[]
  redAlerts      RedAlert[]
}

model CliqNotice {
  id        String    @id @default(cuid())
  cliqId    String
  type      String
  content   String
  createdAt DateTime  @default(now())
  expiresAt DateTime?
  cliq      Cliq      @relation(fields: [cliqId], references: [id], onDelete: Cascade)

  @@index([cliqId])
  @@index([expiresAt])
}

model Post {
  id        String    @id @default(cuid())
  content   String
  image     String?
  createdAt DateTime  @default(now())
  deleted   Boolean   @default(false)
  authorId  String
  cliqId    String
  expiresAt DateTime?
  author    User      @relation(fields: [authorId], references: [id])
  cliq      Cliq      @relation(fields: [cliqId], references: [id])
  replies   Reply[]
}

model Reply {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  postId    String
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  post      Post     @relation(fields: [postId], references: [id])
}

model Invite {
  id                    String       @id @default(cuid())
  token                 String       @unique
  code                  String?      @unique
  inviteeEmail          String
  targetEmailNormalized String       @db.VarChar(320)
  targetUserId          String?
  targetState           TargetState
  inviterId             String
  cliqId                String?
  status                InviteStatus @default(pending)
  used                  Boolean      @default(false)
  acceptedAt            DateTime?
  completedAt           DateTime?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  invitedUserId         String?
  isApproved            Boolean      @default(false)
  expiresAt             DateTime?
  invitedRole           String?
  maxUses               Int?
  message               String?
  friendFirstName       String?
  inviteNote            String?
  inviteType            String?
  trustedAdultContact   String?
  parentAccountExists   Boolean?
  cliq                  Cliq?        @relation("CliqInvites", fields: [cliqId], references: [id])
  inviter               User         @relation("SentInvites", fields: [inviterId], references: [id])

  @@index([targetEmailNormalized])
  @@index([status, used])
  @@index([token])
}

model InviteRequest {
  id           String   @id @default(cuid())
  email        String
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  cliqId       String
  invitedRole  String
  inviteeEmail String
  inviterId    String
  cliq         Cliq     @relation("CliqInviteRequests", fields: [cliqId], references: [id])
  inviter      User     @relation("InviteRequestsSent", fields: [inviterId], references: [id])
}

model ParentLink {
  id            String   @id @default(cuid())
  parentId      String
  email         String
  childId       String
  type          String   @default("family")
  inviteContext String?
  createdAt     DateTime @default(now())
  child         User     @relation("ParentChildLinks", fields: [childId], references: [id])
  parent        User     @relation("ParentLinks", fields: [parentId], references: [id])

  @@unique([parentId, childId])
  @@unique([email, childId])
}

model ParentAuditLog {
  id        String   @id @default(cuid())
  parentId  String
  childId   String
  action    String
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())
  parent    User     @relation("ParentAuditLogs", fields: [parentId], references: [id])
}

model RedAlert {
  id            String   @id @default(cuid())
  cliqId        String
  triggeredById String
  reason        String?
  triggeredAt   DateTime @default(now())
  cliq          Cliq     @relation(fields: [cliqId], references: [id])
  triggeredBy   User     @relation(fields: [triggeredById], references: [id])
}

model PasswordResetAudit {
  id        String   @id @default(cuid())
  email     String
  ip        String?
  event     String
  createdAt DateTime @default(now())
}

model Membership {
  id       String   @id @default(cuid())
  userId   String
  cliqId   String
  role     String   @default("Member")
  joinedAt DateTime @default(now())
  cliq     Cliq     @relation(fields: [cliqId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([userId, cliqId])
}

model ScrapbookItem {
  id        String    @id @default(cuid())
  profileId String
  imageUrl  String
  caption   String    @default("")
  isPinned  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  myProfile MyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model UserActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  event     String
  detail    String?
  debugId   String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

enum InviteStatus {
  pending
  accepted
  completed
  canceled
}

enum TargetState {
  new
  existing_parent
  existing_user_non_parent
  invalid_child
}

enum AIModerationLevel {
  strict
  moderate
  relaxed
}

enum CliqPrivacy {
  private
  semi_private
  public
}
