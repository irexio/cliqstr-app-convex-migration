generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String          @id @default(cuid())
  email               String          @unique
  password            String
  resetToken          String?
  resetTokenExpires   DateTime?
  verificationToken   String?
  verificationExpires DateTime?
  isApproved          Boolean         @default(false)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  account             Account?
  ownedCliqs          Cliq[]          @relation("CliqOwner")
  invitesSent         Invite[]        @relation("SentInvites")
  inviteRequestsSent  InviteRequest[] @relation("InviteRequestsSent")
  memberships         Membership[]
  children            ParentLink[]    @relation("ChildLinks")
  parentLinks         ParentLink[]
  Post                Post[]
  profile             Profile?
  redAlertsTriggered  RedAlert[]
  Reply               Reply[]
}

model Profile {
  id                String            @id @default(cuid())
  userId            String            @unique
  username          String            @unique
  birthdate         DateTime
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  ageGroup          String?
  aiModerationLevel AIModerationLevel @default(strict)
  about             String?
  image             String?
  bannerImage       String?
  firstName         String?
  lastName          String?
  childSettings     ChildSettings?
  user              User              @relation(fields: [userId], references: [id])
}

model ParentLink {
  id        String   @id @default(cuid())
  parentId  String?
  childId   String
  email     String?
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())
  child     User     @relation("ChildLinks", fields: [childId], references: [id])
  parent    User?    @relation(fields: [parentId], references: [id])
}

model ChildSettings {
  id                   String  @id @default(cuid())
  profileId            String  @unique
  canCreatePublicCliqs Boolean @default(false)
  canSendInvites       Boolean @default(false)
  isSilentlyMonitored  Boolean @default(true)
  canAccessGames       Boolean @default(false)
  canPostImages        Boolean @default(false)
  canShareYouTube      Boolean @default(false)
  visibilityLevel      String?
  aiModerationLevel    String?
  profile              Profile @relation(fields: [profileId], references: [id])
}

/// üîê APA ‚Äî System-level metadata for each user
model Account {
  id               String   @id @default(cuid())
  userId           String   @unique
  role             String
  isApproved       Boolean  @default(false)
  stripeStatus     String?
  plan             String?
  stripeCustomerId String?
  createdAt        DateTime @default(now())
  suspended        Boolean  @default(false)
  user             User     @relation(fields: [userId], references: [id])
}

model Cliq {
  id             String          @id @default(cuid())
  name           String
  description    String?
  privacy        String          @default("private")
  coverImage     String?
  createdAt      DateTime        @default(now())
  deleted        Boolean         @default(false)
  deletedAt      DateTime?
  ownerId        String
  owner          User            @relation("CliqOwner", fields: [ownerId], references: [id])
  invites        Invite[]        @relation("CliqInvites")
  inviteRequests InviteRequest[] @relation("CliqInviteRequests")
  memberships    Membership[]
  posts          Post[]
  redAlerts      RedAlert[]
}

model Post {
  id        String    @id @default(cuid())
  content   String
  image     String?
  createdAt DateTime  @default(now())
  deleted   Boolean   @default(false)
  expiresAt DateTime?
  authorId  String
  cliqId    String
  author    User      @relation(fields: [authorId], references: [id])
  cliq      Cliq      @relation(fields: [cliqId], references: [id])
  replies   Reply[]
}

model Reply {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  postId    String
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  post      Post     @relation(fields: [postId], references: [id])
}

model Invite {
  code                String    @unique
  id                  String    @id @default(cuid())
  cliqId              String
  invitedUserId       String?
  inviterId           String
  invitedRole         String
  inviteeEmail        String
  status              String    @default("pending")
  isApproved          Boolean   @default(false)
  createdAt           DateTime  @default(now())
  expiresAt           DateTime?
  maxUses             Int
  used                Boolean   @default(false)
  message             String?
  friendFirstName     String?
  trustedAdultContact String?
  inviteNote          String?
  inviteType          String?
  cliq                Cliq      @relation("CliqInvites", fields: [cliqId], references: [id])
  inviter             User      @relation("SentInvites", fields: [inviterId], references: [id])
}

model InviteRequest {
  id           String   @id @default(cuid())
  email        String
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  cliqId       String
  invitedRole  String
  inviteeEmail String
  inviterId    String
  cliq         Cliq     @relation("CliqInviteRequests", fields: [cliqId], references: [id])
  inviter      User     @relation("InviteRequestsSent", fields: [inviterId], references: [id])
}

model ParentAuditLog {
  id        String   @id @default(cuid())
  parentId  String
  childId   String
  action    String
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())
}

model RedAlert {
  id            String   @id @default(cuid())
  cliqId        String
  triggeredById String
  reason        String?
  triggeredAt   DateTime @default(now())
  cliq          Cliq     @relation(fields: [cliqId], references: [id])
  triggeredBy   User     @relation(fields: [triggeredById], references: [id])
}

model PasswordResetAudit {
  id        String   @id @default(cuid())
  email     String
  ip        String?
  event     String
  createdAt DateTime @default(now())
}

model Membership {
  id       String   @id @default(cuid())
  userId   String
  cliqId   String
  role     String   @default("Member")
  joinedAt DateTime @default(now())
  cliq     Cliq     @relation(fields: [cliqId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([userId, cliqId])
}

enum AIModerationLevel {
  strict
  moderate
  relaxed
}

enum CliqPrivacy {
  private
  semi_private
  public
}
